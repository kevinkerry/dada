(function () {
    var loading = document.querySelector('.u-loading')
    var imageList = document.querySelector('.image-list')
    var uploadBtn = document.querySelector('#uploadBtn')
    var uploadBtnParent = uploadBtn.parentNode;
    uploadBtn.addEventListener('change', function () {
        var files = this.files;
        if (imageList.querySelectorAll('.img').length + files.length > 8) {
            alert('哒人形象照最多上传8张')
            return
        }
        var fileArr = [], orientations = [], imageDatas = [], index = 0;
        readFile(files, fileArr, orientations, imageDatas, index)
    })

    function readFile(files, fileArr, orientations, imageDatas, index) {
        if(index == 0){
            loading.style.display = 'block';
        }
        var file = files[index++];
        if (file.type.indexOf('image/') != 0) {
            alert('文件格式不正确,请上传图片');
            return
        }
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function () {
            var imageData = this.result;
            if (isIos()) {
                var exifImg = new Image();
                exifImg.setAttribute('src', imageData)
                exifImg.addEventListener('load', function () {
                    var self = this;
                    EXIF.getData(self, function () {
                        var orientation = EXIF.getTag(this, 'Orientation')
                        if (orientation && orientation == 6) {
                            var mpImg = new MegaPixImage(file);
                            var canvas = document.createElement('canvas');
                            mpImg.render(canvas, { maxWidth: 800, maxHeight: 800*self.naturalHeight/self.naturalWidth, quality: 1.0, orientation: orientation}, function () {
                                orientations.push(orientation)
                                imageDatas.push(canvas.toDataURL())
                                fileArr.push(file)
                                if(fileArr.length == files.length){
                                    uploadFile(fileArr, orientations)
                                }else{
                                    readFile(files, fileArr, orientations, imageDatas, index)
                                }
                            });
                        } else {
                            orientations.push(1)
                            imageDatas.push(imageData)
                            fileArr.push(file)
                            if(fileArr.length == files.length){
                                uploadFile(fileArr, orientations, imageDatas)
                            }else{
                                readFile(files, fileArr, orientations, imageDatas, index)
                            }
                        }
                    });
                })
            } else {
                orientations.push(1)
                fileArr.push(file)
                imageDatas.push(imageData)
                if(fileArr.length == files.length){
                    uploadFile(fileArr, orientations, imageDatas)
                }else{
                    readFile(files, fileArr, orientations, imageDatas, index)
                }
            }
        }
    }
    function uploadFile(files, orientations, imageDatas) {
        var formData = new FormData();
        for(var i= 0,j=files.length; i<j; i++){
            formData.append('files['+i+']', files[i])
        }
        formData.append('orientations', orientations)
        var xhr = new XMLHttpRequest()
        xhr.open('POST', ctx + '/upload')
        xhr.onload = function () {
            loading.style.display = 'none';
            var result = JSON.parse(xhr.responseText)
            if (result.state == 'success') {
                    for(var i= 0,j=imageDatas.length; i<j; i++){
                        var div = document.createElement('div')
                        div.classList.add('img')
                        div.setAttribute('data-src', result.results.path[i])
                        div.style.backgroundImage = 'url(' + imageDatas[i] + ')';
                        var deleteBtn = document.createElement('i');
                        deleteBtn.classList.add('iconfont');
                        deleteBtn.classList.add('icon-shanchu');
                        div.appendChild(deleteBtn);
                       
                        imageList.insertBefore(div, uploadBtnParent);
                    }
                //var imgs = result.results.path;
                //if(imgs){
                //    for(var i= 0,j=imgs.length; i<j; i++){
                //        var div = document.createElement('div')
                //        div.classList.add('img')
                //        div.setAttribute('data-src', imgs[i])
                //        div.style.backgroundImage = 'url(http://image.dadasports.cn' + imgs[i] + ')';
                //        var deleteBtn = document.createElement('i')
                //        deleteBtn.classList.add('iconfont')
                //        deleteBtn.classList.add('icon-shanchu')
                //        div.appendChild(deleteBtn)
                //        deleteBtn.addEventListener('click', function () {
                //            this.parentNode.parentNode.removeChild(this.parentNode)
                //        })
                //        imageList.insertBefore(div, uploadBtnParent)
                //    }
                //}
            } else {
                alert(result.message)
            }
        }
        xhr.send(formData)
    }

    var club = document.querySelector('.club')
    var clubName = document.querySelector('#clubName')
    document.querySelector('#joinClub').addEventListener('change', function () {
        club.classList.toggle('active')
        if (club.classList.contains('active')) {
            clubName.focus()
        }
    })

    var moreInfo = document.querySelector('#moreInfo')
    document.querySelector('#moreBtn').addEventListener('click', function () {
        moreInfo.classList.toggle('active')
        if (moreInfo.classList.contains('active')) {
            this.innerText = '收起'
            moreInfo.classList.add('fadeInDown')
        } else {
            this.innerText = '更多'
        }
    })
    moreInfo.addEventListener('webkitAnimationEnd', function () {
        this.classList.remove('fadeInDown')
    })

    var courseContainer = document.querySelector('.course-container')
    var itemCourseTemp = document.querySelector('.item-list-course')
    var addBtn = itemCourseTemp.querySelector('.icon-tianjia')
    var deleteBtn = itemCourseTemp.querySelector('.icon-jianshao')
    deleteBtn.addEventListener('click', function () {
        itemCourseTemp.classList.add('fadeInUp')
        itemCourseTemp.addEventListener('webkitAnimationEnd', function () {
            courseContainer.removeChild(itemCourseTemp)
            var templates = courseContainer.querySelectorAll('.item-list-course')
            templates[templates.length - 1].querySelector('.icon-tianjia').style.display = 'inline-block';
            if (templates.length == 1) {
                templates[0].querySelector('.icon-jianshao').style.display = 'none';
            }
        })
    })
    addBtn && addBtn.addEventListener('click', function () {
        deleteBtn.style.display = 'inline-block';
        this.style.display = 'none';
        getNewNode()
    })

    function getNewNode() {
        var templates = courseContainer.querySelectorAll('.item-list-course')
        var newNode = templates[templates.length - 1].cloneNode(true)
        var formInputs = newNode.querySelectorAll('.form-input')
        for (var i = 0, j = formInputs.length; i < j; i++) {
            formInputs[i].value = '';
        }
        newNode.addEventListener('webkitAnimationEnd', function () {
            this.classList.remove('fadeInDown')
        })
        newNode.classList.add('fadeInDown')
        var addBtn = newNode.querySelector('.icon-tianjia')
        var deleteBtn = newNode.querySelector('.icon-jianshao')
        deleteBtn.addEventListener('click', function () {
            newNode.classList.add('fadeInUp')
            newNode.addEventListener('webkitAnimationEnd', function () {
                courseContainer.removeChild(newNode)
                var templates = courseContainer.querySelectorAll('.item-list-course')
                templates[templates.length - 1].querySelector('.icon-tianjia').style.display = 'inline-block';
                if (templates.length == 1) {
                    templates[0].querySelector('.icon-jianshao').style.display = 'none';
                }
            })
        })
        addBtn.style.display = 'inline-block';
        addBtn.addEventListener('click', function () {
            deleteBtn.style.display = 'inline-block';
            this.style.display = 'none';
            getNewNode()
        })
        courseContainer.appendChild(newNode)
    }

    var formInputs = document.querySelectorAll('.form-input')
    for (var i = 0, j = formInputs.length; i < j; i++) {
        formInputs[i].addEventListener('focus', function () {
            var parent = getParentNode(this, 'item')
            parent.classList.add('active')
        })
        formInputs[i].addEventListener('blur', function () {
            var parent = getParentNode(this, 'item')
            parent.classList.remove('active')
        })
    }
    function getParentNode(node, className) {
        var parent = node.parentNode;
        if (parent.classList.contains(className)) {
            return parent
        }
        return getParentNode(parent, className)
    }

    document.querySelector('#saveBtn').addEventListener('click', function () {
        var params = {}
        var imgs = imageList.querySelectorAll('.img');
        if (imgs.length < 4) {
            alert('哒人形象照最少上传4张');
            //console.log(1);
            return
        }
        for (var i = 0, j = imgs.length; i < j; i++) {
            var imgUrl = imgs[i].getAttribute('data-src');
            var imgID = imgs[i].getAttribute('data-id');
            if (imgUrl) {
            	if(imgID){
                    params['images[' + i + '].id'] = imgID
            	}
                params['images[' + i + '].imageUrl'] = imgUrl
            }
            //console.log(2);
        }
        var baseInfo = document.querySelector('.base-info')
        var baseInfoForms = baseInfo.querySelectorAll('.form-input')
        for (var i = 0, j = baseInfoForms.length; i < j; i++) {
            var formInput = baseInfoForms[i];
            var value = formInput.value || '';
            if (!checkValue(formInput, value)) {
                return
            }
            
            params[formInput.getAttribute('id')] = value;
        }
        //console.log(3);
        var moreInfoForms = moreInfo.querySelectorAll('.form-input')
        for (var i = 0, j = moreInfoForms.length; i < j; i++) {
            var formInput = moreInfoForms[i];
            var value = formInput.value || '';
            params[formInput.getAttribute('id')] = value;
        }
        var itemListCourses = document.querySelectorAll('.item-list-course')
        for (var i = 0, j = itemListCourses.length; i < j; i++) {
            var itemListCourse = itemListCourses[i];
            var itemListCourseInputs = itemListCourse.querySelectorAll('.form-input')
            for (var m = 0, n = itemListCourseInputs.length; m < n; m++) {
                var formInput = itemListCourseInputs[m];
               // console.info(formInput)
                var value = formInput.value || '';
               // console.log(value);
                if (!checkValue(formInput, value)) {
                    return
                }
                params['items[' + i + '].' + formInput.getAttribute('name')] = value;
            }
        }
        //console.log(4);
        var formData = new FormData()
        for (var prop in params) {
            if (params.hasOwnProperty(prop)) {
                formData.append(prop, params[prop])
            }
        }
        var xhr = new XMLHttpRequest()
        xhr.open('POST', ctx + '/intelligent/update')
        xhr.onload = function () {
            loading.style.display = 'none';
            alert('修改成功!')
            location.href = ctx + '/intelligent/list'
        }
        loading.style.display = 'block';
        xhr.send(formData);
        //console.log(5);
    })

    function checkValue(formInput, value) {
        if (formInput.getAttribute('required') && value.length == 0) {
            alert(formInput.getAttribute('placeholder'))
            formInput.focus()
            return false
        }
        var pattern = formInput.getAttribute('pattern')
        if (pattern && !new RegExp(pattern).test(value)) {
            alert(formInput.getAttribute('pattern-msg'))
            formInput.focus()
            return false
        }
        return true;
    }

    function isIos() {
        return !!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)
    }
    var message = document.querySelector('.u-message')
    var messageTimeOut;
    function hiddenMessage(){
        message.removeEventListener('webkitTransitionEnd', hiddenMessage, false)
        if(messageTimeOut){
            clearTimeout(messageTimeOut)
        }
        messageTimeOut = setTimeout(function () {
            message.classList.remove('show')
        }, 3000)
    }
    var messageTitle = document.querySelector('.u-message-title')

    function showMessage(title) {
        messageTitle.innerHTML = title;
        message.addEventListener('webkitTransitionEnd', hiddenMessage, false)
        message.classList.add('show')
    }
})()